name: Workflow de Continuous Delivery

on: 
  workflow_call:
    inputs:
      working-directory:
        description: "Diretório da app (Dockerfile, relatórios etc.)"
        type: string
        default: "app"
      aws-region:
        description: "Região AWS"
        type: string
        default: "us-east-1"
      deploy-type:
        description: "Tipo de Recurso (ECS ou EKS)"
        type: string
        default: "ecs"
    secrets:
      AWS_ROLE_TO_ASSUME:
        description: "Role AWS para OIDC"
        required: true
      COSIGN_KEY_PUB:
        description: "cosign.key em Base64"
        required: true
      COSIGN_PASSWORD:
        description: "Senha da cosign.key"
        required: true
        
permissions:
  id-token: write
  contents: read

env:
  WORKDIR: ${{ inputs.working-directory }}
  AWS_REGION: ${{ inputs.aws-region }}

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      full_image: ${{ steps.compile.outputs.full_image }}

    steps:
      - name: "Checkout"
        uses: actions/checkout@v4

      - name: Configurar credenciais AWS (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: "Compila nome do repo"
        id: compile
        run: |
          REGISTRY="${{ steps.login-ecr.outputs.registry }}"
          FULL_IMAGE="$( echo "${REGISTRY}/${{ vars.IMAGE_NAME }}:${{ github.sha }}" | tr '[:upper:]' '[:lower:]' )"
          echo "full_image=${FULL_IMAGE}" >> "$GITHUB_OUTPUT"

      - name: "Install Cosign"
        uses: sigstore/cosign-installer@v3.4.0

      - name: Prepare Cosign public key
        run: |
          PUB_PATH="${{ inputs.working-directory }}/cosign.pub"
          echo "${{ secrets.COSIGN_KEY_PUB }}" | base64 -d > "$PUB_PATH"
          chmod 644 "$PUB_PATH"
          echo "COSIGN_PUB_PATH=$PUB_PATH" >> "$GITHUB_ENV"

      - name: Cosign - Verify signature
        id: verify-signature
        run: |
          cosign version
          cosign verify --key "${COSIGN_PUB_PATH}" --insecure-ignore-tlog "${{ steps.compile.outputs.full_image }}"
          
  ecs-deploy:
    needs: prepare
    if: ${{ inputs.deploy-type == 'ecs' && needs.prepare.result == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: "Checkout"
        uses: actions/checkout@v4

      - name: Configurar credenciais AWS (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Get Task Definition
        run: |
          aws ecs describe-task-definition --task-definition ${{ vars.TASK_NAME }} --query taskDefinition > task-definition.json
          echo $(cat task-definition.json | jq 'del(
                  .taskDefinitionArn,
                  .requiresAttributes,
                  .compatibilities,
                  .revision,
                  .status,
                  .registeredAt,
                  .registeredBy
             )') > task-definition.json

      - name: Render Task Definition
        id: render
        uses: aws-actions/amazon-ecs-render-task-definition@v1
        with:
          task-definition: task-definition.json
          container-name: ${{ vars.CONTAINER_NAME }}
          image: ${{ needs.prepare.outputs.full_image }}

      - name: Deploy to Amazon ECS
        if: ${{ needs.prepare.result == 'success' }}
        uses: aws-actions/amazon-ecs-deploy-task-definition@v2
        with:
          task-definition: ${{ steps.render.outputs.task-definition }}
          service: ${{ vars.SERVICE_NAME }}
          cluster: ${{ vars.CLUSTER_NAME }}
          wait-for-service-stability: true

  eks-deploy:
    needs: prepare
    if: ${{ inputs.deploy-type == 'eks-kubectl' && needs.prepare.result == 'success'}}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configurar credenciais AWS (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'latest'

      - name: Configure kubeconfig
        run: |
          aws eks update-kubeconfig --name "${{ vars.EKS_CLUSTER_NAME }}" --region "${{ env.AWS_REGION }}"
          kubectl version --client=true

      - name: Render Kubernetes manifests
        if: ${{ needs.prepare.result == 'success' }}
        env:
          IMAGE: ${{ needs.prepare.outputs.full_image }}
          NAMESPACE: ${{ vars.K8S_NAMESPACE }}
        run: |
          mkdir -p k8s-rendered
          for f in k8s/*.yaml; do
            echo "Renderizando ${f} -> k8s-rendered/$(basename "$f")"
            envsubst '$IMAGE $NAMESPACE' < "$f" > "k8s-rendered/$(basename "$f")"
          done
          echo "=== Preview do deployment renderizado ==="
          sed -n '1,120p' k8s-rendered/deployment.yaml || true

      - name: Apply Kubernetes manifests
        if: ${{ needs.prepare.result == 'success' }}
        run: |
          kubectl apply -f k8s-rendered

      - name: Wait rollout
        if: ${{ needs.prepare.result == 'success' }}
        run: |
          set -e
          DEPLOY=$(kubectl get deploy -n "${{ vars.K8S_NAMESPACE }}" -o name | head -n1)
          echo "Aguardando rollout de: $DEPLOY"
          kubectl -n "${{ vars.K8S_NAMESPACE }}" rollout status "$DEPLOY" --timeout=5m

      - name: Check deployment image
        if: ${{ needs.prepare.result == 'success' }}
        run: |
          echo "Imagem em execução:"
          kubectl -n "${{ vars.K8S_NAMESPACE }}" get deploy -o jsonpath='{.items[*].spec.template.spec.containers[*].image}' || true
          echo

  eks-deploy-gitops:
    needs: prepare
    if: ${{ inputs.deploy-type == 'eks-argocd' && needs.prepare.result == 'success'}}
    runs-on: ubuntu-latest

    permissions:
      id-token: write
      contents: write

    env:
      VALUES_FILE: manifests/values.yaml

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configurar credenciais AWS (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}


      - name: Atualiza tag da imagem em values.yaml
        env:
          FULL_IMAGE: ${{ needs.prepare.outputs.full_image }}
        run: |
          sed -i "s|^\(.*image:[[:space:]]*\).*|\1${FULL_IMAGE}|" "$VALUES_FILE"

      - name: Commit e push da alteração
        env:
          TARGET_BRANCH: ${{ github.ref_name }}
        run: |
          git config --global user.name  "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          git add "$VALUES_FILE"
          git commit -m "ci: Atualizada a image para ${{ needs.prepare.outputs.full_image }}" || echo "Nada para commitar"

          git branch
          git rev-parse --abbrev-ref HEAD
          git push origin "$TARGET_BRANCH"